(function(){"use strict";var e={1213:function(e,t,s){var r=s(5130),a=s(6768);const o={id:"app"};function i(e,t,s,r,i,n){const l=(0,a.g2)("SettingPanel"),p=(0,a.g2)("ChatBox");return(0,a.uX)(),(0,a.CE)("div",o,[(0,a.bF)(l,{currentChatId:i.currentChatId,onModelChanged:n.handleModelChange,onChatSelected:n.handleChatSelected,onChatDeleted:n.handleChatDeleted,ref:"settingPanel"},null,8,["currentChatId","onModelChanged","onChatSelected","onChatDeleted"]),(0,a.bF)(p,{currentChat:i.currentChat,selectedModel:i.selectedModel,onChatUpdated:n.handleChatUpdated,onNewChat:n.handleCreateNewChat},null,8,["currentChat","selectedModel","onChatUpdated","onNewChat"])])}var n=s(4232);const l={class:"chat-container"},p={class:"chat-header"},d={class:"header-actions"},c={class:"chat-messages",ref:"messagesContainer"},h={key:0,class:"welcome-message"},u={class:"message-content"},m={class:"avatar"},y={key:0,class:"user-avatar"},g={key:1,class:"ai-avatar"},v={class:"message-text"},C={key:0,class:"typing-indicator"},k=["innerHTML"],f={class:"chat-input-container"},b={class:"chat-input-toolbar"},w={class:"input-wrapper fill"},L=["disabled"],P=["disabled"],T={key:0,width:"16",height:"16",viewBox:"0 0 24 24",fill:"none"},M={key:1,class:"loading-spinner"},x={key:0,class:"debug-panel"},A={class:"debug-header"},S={class:"debug-section"},I=["textContent"],H={class:"debug-section"},K={class:"debug-pre"},D={class:"debug-section"},$={class:"debug-pre"},E={class:"debug-section"},_=["textContent"];function O(e,t,s,o,i,O){return(0,a.uX)(),(0,a.CE)("div",l,[(0,a.Lk)("div",p,[(0,a.Lk)("h1",null,(0,n.v_)(O.currentModel)+" - "+(0,n.v_)(O.currentChatTitle),1),(0,a.Lk)("div",d,[(0,a.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>O.toggleDebug&&O.toggleDebug(...e)),class:(0,n.C4)(["debug-button",{active:i.showDebug}])},t[8]||(t[8]=[(0,a.Lk)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none"},[(0,a.Lk)("path",{d:"M3 4h18M3 12h18M3 20h18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),(0,a.eW)(" Debug ",-1)]),2),(0,a.Lk)("button",{onClick:t[1]||(t[1]=(...e)=>O.clearChat&&O.clearChat(...e)),class:"clear-button"},t[9]||(t[9]=[(0,a.Lk)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none"},[(0,a.Lk)("path",{d:"M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),(0,a.eW)(" 清空对话 ",-1)]))])]),(0,a.Lk)("div",c,[0===i.messages.length?((0,a.uX)(),(0,a.CE)("div",h,t[10]||(t[10]=[(0,a.Lk)("div",{class:"welcome-content"},[(0,a.Lk)("h2",null,"Hello! I'm ChatGPT"),(0,a.Lk)("p",null,"我是一个AI助手，很高兴为您服务。请问有什么可以帮助您的吗？")],-1)]))):(0,a.Q3)("",!0),((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.messages,e=>((0,a.uX)(),(0,a.CE)("div",{key:e.id,class:(0,n.C4)(["message-wrapper",e.type])},[(0,a.Lk)("div",u,[(0,a.Lk)("div",m,["user"===e.type?((0,a.uX)(),(0,a.CE)("div",y,"U")):((0,a.uX)(),(0,a.CE)("div",g,t[11]||(t[11]=[(0,a.Lk)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},[(0,a.Lk)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"})],-1)])))]),(0,a.Lk)("div",v,["assistant"===e.type&&e.isTyping?((0,a.uX)(),(0,a.CE)("div",C,t[12]||(t[12]=[(0,a.Lk)("span",null,null,-1),(0,a.Lk)("span",null,null,-1),(0,a.Lk)("span",null,null,-1)]))):((0,a.uX)(),(0,a.CE)("div",{key:1,innerHTML:O.renderedMessage(e.text)},null,8,k))])])],2))),128))],512),(0,a.Lk)("div",f,[(0,a.Lk)("div",b,[(0,a.Lk)("button",{class:"new-chat-btn",onClick:t[2]||(t[2]=t=>e.$emit("new-chat"))},t[13]||(t[13]=[(0,a.Lk)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none"},[(0,a.Lk)("path",{d:"M12 5v14M5 12h14",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),(0,a.eW)(" 新对话 ",-1)]))]),(0,a.Lk)("div",w,[(0,a.bo)((0,a.Lk)("textarea",{"onUpdate:modelValue":t[3]||(t[3]=e=>i.currentMessage=e),onKeydown:t[4]||(t[4]=(...e)=>O.handleKeydown&&O.handleKeydown(...e)),onInput:t[5]||(t[5]=(...e)=>O.adjustTextareaHeight&&O.adjustTextareaHeight(...e)),placeholder:"Ctrl+Enter 发送 (Mac: Cmd+Enter)...",class:"message-input",rows:"1",disabled:i.isLoading,ref:"messageInput"},null,40,L),[[r.Jo,i.currentMessage]]),(0,a.Lk)("button",{onClick:t[6]||(t[6]=(...e)=>O.sendMessage&&O.sendMessage(...e)),disabled:!i.currentMessage.trim()||i.isLoading,class:"send-button"},[i.isLoading?((0,a.uX)(),(0,a.CE)("div",M)):((0,a.uX)(),(0,a.CE)("svg",T,t[14]||(t[14]=[(0,a.Lk)("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 11L11 13",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])))],8,P)])]),i.showDebug?((0,a.uX)(),(0,a.CE)("div",x,[(0,a.Lk)("div",A,[t[15]||(t[15]=(0,a.Lk)("span",null,"Debug 信息",-1)),(0,a.Lk)("button",{class:"close-btn",onClick:t[7]||(t[7]=(...e)=>O.toggleDebug&&O.toggleDebug(...e))},"×")]),(0,a.Lk)("div",S,[t[16]||(t[16]=(0,a.Lk)("h4",null,"当前系统 Prompt",-1)),(0,a.Lk)("pre",{class:"debug-pre",textContent:(0,n.v_)(O.currentSystemPrompt||"（无）")},null,8,I)]),(0,a.Lk)("div",H,[t[17]||(t[17]=(0,a.Lk)("h4",null,"最后一次请求 Payload (已脱敏)",-1)),(0,a.Lk)("pre",K,(0,n.v_)(O.formattedLastRequest),1)]),(0,a.Lk)("div",D,[t[18]||(t[18]=(0,a.Lk)("h4",null,"最后一次原始响应 JSON",-1)),(0,a.Lk)("pre",$,(0,n.v_)(i.lastResponseRaw),1)]),(0,a.Lk)("div",E,[t[19]||(t[19]=(0,a.Lk)("h4",null,"最后一次生成文本",-1)),(0,a.Lk)("pre",{class:"debug-pre",textContent:(0,n.v_)(i.lastResponseText||"（无）")},null,8,_)])])):(0,a.Q3)("",!0)])}s(4114),s(8111),s(2489),s(1701);const j=e=>`llm_api_key_${e}`;function J(e){try{return localStorage.getItem(j(e))||""}catch{return""}}function R(e){const t=J(e);return!!t&&t.length>10}function U(e){switch(e){case"deepseek":return{name:"DeepSeek",apiUrl:"https://api.deepseek.com/v1/chat/completions",defaultParams:{temperature:.7,max_tokens:4e3}};case"openai":default:return{name:"OpenAI",apiUrl:"https://api.openai.com/v1/chat/completions",defaultParams:{}}}}function X({provider:e,model:t,messages:s,temperature:r,maxTokens:a}){const o=U(e);return{model:t,messages:s,temperature:r??o.defaultParams.temperature,max_tokens:a??o.defaultParams.max_tokens}}function F(e){const t=J(e);return{"Content-Type":"application/json",Authorization:`Bearer ${t}`}}function N(e){return R(e)}var B=s(642),G=s(1109),V=(s(8e3),s(2563)),W=s.n(V),q=s(8199),z=s.n(q),Q=s(8353);window.MathJax||(window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,tags:"none"},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code"],ignoreHtmlClass:"tex2jax_ignore"},startup:{typeset:!1}},console.log("[MathJax] config injected"));try{Q.A.setConfig({USE_PROFILES:{html:!0}})}catch(Ue){}var Y={name:"ChatBox",props:{currentChat:{type:Object,default:null},selectedModel:{type:String,default:"gpt-4.1"}},data(){return{currentMessage:"",messages:[],isLoading:!1,showDebug:!1,lastRequestPayload:null,lastResponseRaw:"",lastResponseText:"",md:null,mathJaxReady:!1,mjTypesetTimer:null}},computed:{currentModel(){const e=this.selectedModel||"",t=e.includes(":")?e.split(":").slice(1).join(":"):e;return t.toUpperCase()},currentChatTitle(){return this.currentChat?this.currentChat.title:"新对话"},currentSystemPrompt(){return this.currentChat&&this.currentChat.systemPrompt?this.currentChat.systemPrompt:""},formattedLastRequest(){if(!this.lastRequestPayload)return"（无）";try{return JSON.stringify(this.lastRequestPayload,null,2)}catch{return"（格式化失败）"}}},watch:{currentChat:{handler(e){e?(this.messages=[...e.messages],this.$nextTick(()=>{this.scrollToBottom()})):this.messages=[]},immediate:!0}},created(){this.md=new B.A({html:!1,linkify:!0,breaks:!0,highlight:(e,t)=>{if(t&&G.A.getLanguage(t))try{const s=G.A.highlight(e,{language:t,ignoreIllegals:!0}).value;return`<pre class="hljs"><code class="language-${t}">${s}</code></pre>`}catch(Ue){}return`<pre class="hljs"><code>${this.md.utils.escapeHtml(e)}</code></pre>`}}).use(W(),{enabled:!0}).use(z(),{multiline:!0,rowspan:!0,headerless:!0});const e=this.md.renderer.rules.fence;this.md.renderer.rules.fence=(t,s,r,a,o)=>{const i=t[s],n=(i.info||"").trim(),l=e?e(t,s,r,a,o):`<pre class="hljs"><code>${this.md.utils.escapeHtml(i.content)}</code></pre>`;return`<div class="code-block-wrapper"><div class="code-block-header"><span>${n||"code"}</span><button class="copy-btn" data-code="${encodeURIComponent(i.content)}">复制</button></div>${l}</div>`}},mounted(){this.$el.addEventListener("click",e=>{const t=e.target.closest(".copy-btn");if(t){const e=decodeURIComponent(t.getAttribute("data-code")||"");navigator.clipboard.writeText(e).then(()=>{t.innerText="已复制",setTimeout(()=>t.innerText="复制",1500)})}}),this.loadMathJax()},updated(){this.scheduleMathTypeset()},methods:{storageKey(){return"chat_history_v1"},persistCurrentChat(){try{const e=localStorage.getItem(this.storageKey());if(!e)return;const t=JSON.parse(e);if(!this.currentChat)return;const s=t.findIndex(e=>String(e.id)===String(this.currentChat.id));s>-1&&(t[s].messages=this.messages.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp})),t[s].updatedAt=(new Date).toISOString(),localStorage.setItem(this.storageKey(),JSON.stringify(t)))}catch(Ue){console.warn("持久化当前对话失败",Ue)}},async sendMessage(){if(!this.currentMessage.trim()||this.isLoading)return;const e={id:Date.now(),text:this.currentMessage.trim(),type:"user",timestamp:new Date};this.messages.push(e),this.currentMessage="",this.adjustTextareaHeight(),this.scrollToBottom(),this.persistCurrentChat();const t={id:Date.now()+1,text:"",type:"assistant",timestamp:new Date,isTyping:!0};this.messages.push(t),this.scrollToBottom(),this.persistCurrentChat();try{this.isLoading=!0;const e=await this.callOpenAI();this.messages.pop(),this.messages.push({id:Date.now()+2,text:e,type:"assistant",timestamp:new Date,isTyping:!1})}catch(s){console.error("OpenAI API Error:",s),this.messages.pop(),this.messages.push({id:Date.now()+2,text:"抱歉，我现在无法回复。请稍后再试。",type:"assistant",timestamp:new Date,isTyping:!1})}finally{this.isLoading=!1,this.scrollToBottom(),this.updateCurrentChat(),this.persistCurrentChat()}},updateCurrentChat(){if(this.currentChat){const e={...this.currentChat,messages:[...this.messages],updatedAt:new Date};this.$emit("chat-updated",e)}},async callOpenAI(){let e="openai",t=this.selectedModel;if(this.selectedModel.includes(":")){const s=this.selectedModel.split(":");e=s[0],t=s.slice(1).join(":")}if(!N(e))return`未检测到 ${e} 的有效 API Key，请在设置面板填写后再试。`;const s=this.buildConversationHistory(),r=X({provider:e,model:t,messages:s});this.lastRequestPayload={provider:e,...r};const a=U(e),o=await fetch(a.apiUrl,{method:"POST",headers:F(e),body:JSON.stringify(r)});if(!o.ok)throw new Error(`API request failed: ${o.status}`);const i=await o.json();this.lastResponseRaw=JSON.stringify(i,null,2);const n=i.choices&&i.choices[0]&&i.choices[0].message?i.choices[0].message.content:"";return this.lastResponseText=n,n},buildConversationHistory(){const e=[];this.currentSystemPrompt&&e.push({role:"system",content:this.currentSystemPrompt});let t=20;this.currentChat&&"number"===typeof this.currentChat.maxHistoryTurns&&(t=this.currentChat.maxHistoryTurns);const s=this.messages.filter(e=>!e.isTyping);if(0===s.length)return e;const r=(()=>{for(let e=s.length-1;e>=0;e--){if("user"===s[e].type)return s[e];if("assistant"===s[e].type)break}return null})(),a=[];for(let i=0;i<s.length;i++){const e=s[i];if("user"===e.type){let t=null;for(let e=i+1;e<s.length;e++){if("assistant"===s[e].type){t=s[e];break}if("user"===s[e].type)break}if(!t&&r&&r===e)break;a.push([{role:"user",content:e.text},...t?[{role:"assistant",content:t.text}]:[]])}}if(0===t)return r&&e.push({role:"user",content:r.text}),e;const o=a.slice(-t).flat();return e.push(...o),r&&e.push({role:"user",content:r.text}),e},handleKeydown(e){"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.sendMessage())},adjustTextareaHeight(){this.$nextTick(()=>{const e=this.$refs.messageInput;e&&(e.closest(".input-wrapper")?.classList.contains("fill")?e.style.height="100%":(e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"))})},loadMathJax(){if(window.MathJax?.typesetPromise)return this.mathJaxReady=!0,void this.scheduleMathTypeset();const e="mathjax-script";if(document.getElementById(e))return;const t=document.createElement("script");t.id=e,t.async=!0,t.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js",t.onload=()=>{this.mathJaxReady=!0,this.scheduleMathTypeset()},t.onerror=()=>console.warn("MathJax 加载失败"),document.head.appendChild(t)},scheduleMathTypeset(){this.mathJaxReady&&(this.mjTypesetTimer&&clearTimeout(this.mjTypesetTimer),this.mjTypesetTimer=setTimeout(()=>this.typesetMath(),40))},typesetMath(){if(!this.mathJaxReady||!window.MathJax?.typesetPromise)return;const e=this.$refs.messagesContainer;if(!e)return;const t=e.querySelectorAll(".message-text");window.MathJax.typesetPromise(Array.from(t)).catch(e=>console.warn("MathJax typeset 错误",e))},renderedMessage(e){if(!this.md)return e;const t=this.md.render(e);return`<span class="mjx-host">${Q.A.sanitize(t)}</span>`},clearChat(){this.messages=[],this.updateCurrentChat(),this.persistCurrentChat()},toggleDebug(){this.showDebug=!this.showDebug},scrollToBottom(){this.$nextTick(()=>{const e=this.$refs.messagesContainer;e&&(e.scrollTop=e.scrollHeight)})}}},Z=s(1241);const ee=(0,Z.A)(Y,[["render",O],["__scopeId","data-v-0ad87c93"]]);var te=ee;const se={class:"setting-panel"},re={class:"section-title"},ae={class:"section-body"},oe={class:"model-select-wrapper"},ie=["value"],ne={class:"model-select-wrapper"},le=["value"],pe={class:"field-label"},de={class:"api-key-input-row"},ce=["type"],he=["disabled"],ue={key:0,class:"api-key-hint"},me={key:1,class:"api-key-hint ok"},ye={class:"section-title"},ge={class:"section-body"},ve={class:"prompt-toolbar"},Ce={class:"prompt-type-select-wrapper"},ke=["value"],fe={class:"prompt-editor-wrapper"},be=["readonly"],we={class:"history-turns-row"},Le={class:"prompt-actions"},Pe=["disabled"],Te={key:0,class:"prompt-status"},Me={class:"section-title"},xe={class:"section-body"},Ae={class:"chat-list"},Se=["onClick"],Ie={class:"chat-title"},He={class:"chat-time"},Ke=["onClick"],De={key:0,class:"empty-state"};function $e(e,t,s,o,i,l){return(0,a.uX)(),(0,a.CE)("div",se,[t[26]||(t[26]=(0,a.Lk)("div",{class:"panel-header"},[(0,a.Lk)("h2",null,"设置")],-1)),(0,a.Lk)("div",{class:(0,n.C4)(["collapsible-section",{collapsed:i.collapsed.model}])},[(0,a.Lk)("div",{class:"section-header clickable",onClick:t[0]||(t[0]=e=>l.toggleCollapse("model"))},[(0,a.Lk)("div",re,[(0,a.Lk)("span",{class:(0,n.C4)(["arrow",{open:!i.collapsed.model}])},"▶",2),t[16]||(t[16]=(0,a.Lk)("h3",null,"模型选择",-1))])]),(0,a.bo)((0,a.Lk)("div",ae,[(0,a.Lk)("div",oe,[t[17]||(t[17]=(0,a.Lk)("label",{class:"field-label"},"提供商",-1)),(0,a.bo)((0,a.Lk)("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>i.selectedProvider=e),onChange:t[2]||(t[2]=(...e)=>l.onProviderChange&&l.onProviderChange(...e)),class:"model-select"},[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.providers,e=>((0,a.uX)(),(0,a.CE)("option",{key:e.value,value:e.value},(0,n.v_)(e.label),9,ie))),128))],544),[[r.u1,i.selectedProvider]]),t[18]||(t[18]=(0,a.Lk)("div",{class:"select-arrow"},[(0,a.Lk)("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none"},[(0,a.Lk)("path",{d:"M6 9l6 6 6-6",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))]),(0,a.Lk)("div",ne,[t[19]||(t[19]=(0,a.Lk)("label",{class:"field-label"},"模型",-1)),(0,a.bo)((0,a.Lk)("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>i.selectedModel=e),onChange:t[4]||(t[4]=(...e)=>l.onModelChange&&l.onModelChange(...e)),class:"model-select"},[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(l.filteredModels,e=>((0,a.uX)(),(0,a.CE)("option",{key:e.value,value:e.value},(0,n.v_)(e.name)+" - "+(0,n.v_)(e.description),9,le))),128))],544),[[r.u1,i.selectedModel]]),t[20]||(t[20]=(0,a.Lk)("div",{class:"select-arrow"},[(0,a.Lk)("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none"},[(0,a.Lk)("path",{d:"M6 9l6 6 6-6",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))]),(0,a.Lk)("div",{class:(0,n.C4)(["api-key-wrapper",{invalid:!l.providerKeyValid}])},[(0,a.Lk)("label",pe,(0,n.v_)(l.currentProviderLabel)+" API Key",1),(0,a.Lk)("div",de,[(0,a.bo)((0,a.Lk)("input",{type:i.showApiKey?"text":"password","onUpdate:modelValue":t[5]||(t[5]=e=>i.apiKeyInput=e),placeholder:"输入并保存当前提供商 API Key",onInput:t[6]||(t[6]=(...e)=>l.onApiKeyInput&&l.onApiKeyInput(...e))},null,40,ce),[[r.hp,i.apiKeyInput]]),(0,a.Lk)("button",{class:"save-key-btn",onClick:t[7]||(t[7]=(...e)=>l.saveCurrentApiKey&&l.saveCurrentApiKey(...e)),disabled:!i.apiKeyDirty||!i.apiKeyInput.trim()},"保存",8,he),(0,a.Lk)("button",{class:"toggle-key-btn",onClick:t[8]||(t[8]=e=>i.showApiKey=!i.showApiKey)},(0,n.v_)(i.showApiKey?"隐藏":"显示"),1)]),l.providerKeyValid?((0,a.uX)(),(0,a.CE)("p",me,"已保存。")):((0,a.uX)(),(0,a.CE)("p",ue,"未检测到有效 Key，请先填写。"))],2)],512),[[r.aG,!i.collapsed.model]])],2),(0,a.Lk)("div",{class:(0,n.C4)(["collapsible-section",{collapsed:i.collapsed.prompt}])},[(0,a.Lk)("div",{class:"section-header clickable",onClick:t[9]||(t[9]=e=>l.toggleCollapse("prompt"))},[(0,a.Lk)("div",ye,[(0,a.Lk)("span",{class:(0,n.C4)(["arrow",{open:!i.collapsed.prompt}])},"▶",2),t[21]||(t[21]=(0,a.Lk)("h3",null,"对话配置",-1))])]),(0,a.bo)((0,a.Lk)("div",ge,[(0,a.Lk)("div",ve,[(0,a.Lk)("div",Ce,[(0,a.bo)((0,a.Lk)("select",{"onUpdate:modelValue":t[10]||(t[10]=e=>i.promptTypeSelection=e),class:"prompt-type-select",onChange:t[11]||(t[11]=(...e)=>l.onPromptTypeChange&&l.onPromptTypeChange(...e))},[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.promptTypeOptions,e=>((0,a.uX)(),(0,a.CE)("option",{key:e.value,value:e.value},(0,n.v_)(e.label),9,ke))),128))],544),[[r.u1,i.promptTypeSelection]])])]),(0,a.Lk)("div",fe,[(0,a.bo)((0,a.Lk)("textarea",{"onUpdate:modelValue":t[12]||(t[12]=e=>i.promptEditorContent=e),class:"prompt-editor",readonly:"自定义"!==i.promptTypeSelection,placeholder:"请输入自定义 Prompt..."},null,8,be),[[r.Jo,i.promptEditorContent]]),(0,a.Lk)("div",we,[t[22]||(t[22]=(0,a.Lk)("label",null,"最大历史对话轮数",-1)),(0,a.bo)((0,a.Lk)("input",{type:"number",min:"0",max:"100","onUpdate:modelValue":t[13]||(t[13]=e=>i.maxHistoryInput=e)},null,512),[[r.Jo,i.maxHistoryInput,void 0,{number:!0}]])]),(0,a.Lk)("div",Le,[(0,a.Lk)("button",{class:"apply-prompt-btn",onClick:t[14]||(t[14]=(...e)=>l.applyPrompt&&l.applyPrompt(...e)),disabled:!s.currentChatId},"应用 Prompt",8,Pe),i.currentChatPromptAppliedAt?((0,a.uX)(),(0,a.CE)("span",Te,"已应用 "+(0,n.v_)(l.formatTime(i.currentChatPromptAppliedAt)),1)):(0,a.Q3)("",!0)])])],512),[[r.aG,!i.collapsed.prompt]])],2),(0,a.Lk)("div",{class:(0,n.C4)(["collapsible-section chat-history-section",{collapsed:i.collapsed.history}])},[(0,a.Lk)("div",{class:"section-header clickable",onClick:t[15]||(t[15]=e=>l.toggleCollapse("history"))},[(0,a.Lk)("div",Me,[(0,a.Lk)("span",{class:(0,n.C4)(["arrow",{open:!i.collapsed.history}])},"▶",2),t[23]||(t[23]=(0,a.Lk)("h3",null,"聊天记录",-1))])]),(0,a.bo)((0,a.Lk)("div",xe,[(0,a.Lk)("div",Ae,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.chatHistory,e=>((0,a.uX)(),(0,a.CE)("div",{key:e.id,class:(0,n.C4)(["chat-item",{active:s.currentChatId===e.id}]),onClick:t=>l.selectChat(e.id)},[(0,a.Lk)("div",Ie,(0,n.v_)(e.title),1),(0,a.Lk)("div",He,(0,n.v_)(l.formatTime(e.updatedAt)),1),(0,a.Lk)("button",{onClick:(0,r.D$)(t=>l.deleteChat(e.id),["stop"]),class:"delete-btn"},t[24]||(t[24]=[(0,a.Lk)("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none"},[(0,a.Lk)("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1)]),8,Ke)],10,Se))),128)),0===i.chatHistory.length?((0,a.uX)(),(0,a.CE)("div",De,t[25]||(t[25]=[(0,a.Lk)("p",null,"暂无聊天记录",-1)]))):(0,a.Q3)("",!0)])],512),[[r.aG,!i.collapsed.history]])],2)])}s(116);var Ee={name:"SettingPanel",props:{currentChatId:{type:[String,Number],default:null}},data(){return{selectedProvider:"openai",providers:[{value:"openai",label:"OpenAI"},{value:"deepseek",label:"DeepSeek"}],selectedModel:"gpt-4.1",models:[{provider:"openai",value:"gpt-4.1",name:"GPT-4.1",description:"高性能通用"},{provider:"openai",value:"gpt-4.1-mini",name:"GPT-4.1 Mini",description:"轻量快速"},{provider:"openai",value:"gpt-5",name:"GPT-5",description:"下一代（示例）"},{provider:"openai",value:"gpt-5-mini",name:"GPT-5 Mini",description:"下一代轻量（示例）"},{provider:"deepseek",value:"deepseek-chat",name:"DeepSeek V3",description:"V3 主力模型"},{provider:"deepseek",value:"deepseek-reasoner",name:"DeepSeek R1",description:"R1 推理模型"}],apiKeyInput:"",apiKeyDirty:!1,showApiKey:!1,chatHistory:[],promptTypeOptions:[{value:"聊天助手",label:"聊天助手"},{value:"中英文互译",label:"中英文互译"},{value:"自定义",label:"自定义"}],promptTypeSelection:"聊天助手",promptEditorContent:"",currentChatPromptAppliedAt:null,collapsed:{model:!1,prompt:!1,history:!1},maxHistoryInput:20}},watch:{currentChatId(e){this.syncPromptUIFromChat(e)},selectedProvider(){this.ensureModelForProvider(),this.loadProviderApiKey()}},computed:{filteredModels(){return this.models.filter(e=>e.provider===this.selectedProvider)},currentProviderLabel(){const e=this.providers.find(e=>e.value===this.selectedProvider);return e?e.label:this.selectedProvider},providerKeyValid(){return this.isApiKeyValidRaw(this.apiKeyInput)}},methods:{providerStorageKey(e){return`llm_api_key_${e}`},loadProviderApiKey(){try{this.apiKeyInput=localStorage.getItem(this.providerStorageKey(this.selectedProvider))||""}catch{this.apiKeyInput=""}this.apiKeyDirty=!1},saveCurrentApiKey(){try{localStorage.setItem(this.providerStorageKey(this.selectedProvider),this.apiKeyInput.trim())}catch(Ue){}this.apiKeyDirty=!1},onApiKeyInput(){this.apiKeyDirty=!0},isApiKeyValidRaw(e){return!!e&&e.trim().length>10},onProviderChange(){this.ensureModelForProvider(),this.loadProviderApiKey(),this.emitModelChanged()},ensureModelForProvider(){if(!this.models.find(e=>e.provider===this.selectedProvider&&e.value===this.selectedModel)){const e=this.models.find(e=>e.provider===this.selectedProvider);e&&(this.selectedModel=e.value)}},onModelChange(){this.emitModelChanged()},emitModelChanged(){this.$emit("model-changed",`${this.selectedProvider}:${this.selectedModel}`),this.saveToStorage()},globalPromptPrefix(){return["【全局输出规范】","1. 所有回答使用 Markdown 格式组织（标题、列表、表格、代码块等）。","2. 代码使用 ```语言\n...\n```，不要省略语言（若不确定可用 text）。","3. 数学公式：行内使用 $公式$，块级使用 $$\n公式\n$$。","4. 若需要同时给出多种方案，使用有序或无序列表。","5. 避免冗长寒暄，直接切入主题。"].join("\n")},composeWithGlobal(e){if(!e)return this.globalPromptPrefix();const t=this.globalPromptPrefix();return e.startsWith(t.slice(0,6))?e:t+"\n\n"+e},ensureGlobal(e){return this.composeWithGlobal(e||"")},toggleCollapse(e){this.collapsed[e]=!this.collapsed[e]},promptPresets(){return{"聊天助手":"你是一个友好、高效且专业的中文智能助手。请使用清晰、结构化的中文回答，必要时使用列表、步骤或示例。除非用户特别要求，请避免多余的寒暄，直接切入重点。","中英文互译":"你是一名专业的中英文互译助手。\n要求：\n1. 识别输入语言，翻译成另一种语言；\n2. 保留原意、语气和专有名词；\n3. 若输入同时含两种语言，则分别给出两种语言的优化版本；\n4. 输出格式：\n- 原文: ...\n- 翻译: ...\n- 备注: ..."}},defaultHistoryTurnsMap(){return{"聊天助手":20,"中英文互译":0,"自定义":10}},storageKey(){return"chat_history_v1"},modelKey(){return"chat_selected_model"},lastChatKey(){return"chat_last_chat_id"},saveToStorage(){try{const e=this.chatHistory.map(e=>({...e,createdAt:e.createdAt instanceof Date?e.createdAt.toISOString():e.createdAt,updatedAt:e.updatedAt instanceof Date?e.updatedAt.toISOString():e.updatedAt,promptAppliedAt:e.promptAppliedAt instanceof Date?e.promptAppliedAt.toISOString():e.promptAppliedAt,maxHistoryTurns:e.maxHistoryTurns??this.defaultHistoryTurnsMap()[e.promptType||"聊天助手"],messages:e.messages.map(e=>({...e,timestamp:e.timestamp instanceof Date?e.timestamp.toISOString():e.timestamp}))}));localStorage.setItem(this.storageKey(),JSON.stringify(e)),localStorage.setItem(this.modelKey(),JSON.stringify({provider:this.selectedProvider,model:this.selectedModel}))}catch(Ue){console.warn("保存聊天记录失败",Ue)}},loadFromStorage(){try{const e=localStorage.getItem(this.storageKey()),t=localStorage.getItem(this.modelKey());if(t){try{const e=JSON.parse(t);e.provider&&(this.selectedProvider=e.provider),e.model&&(this.selectedModel=e.model)}catch{this.selectedModel=t}this.ensureModelForProvider(),this.emitModelChanged(),this.loadProviderApiKey()}else this.emitModelChanged(),this.loadProviderApiKey();if(e){const t=JSON.parse(e);this.chatHistory=t.map(e=>({...e,createdAt:e.createdAt?new Date(e.createdAt):new Date,updatedAt:e.updatedAt?new Date(e.updatedAt):new Date,promptAppliedAt:e.promptAppliedAt?new Date(e.promptAppliedAt):null,promptType:e.promptType||"聊天助手",systemPrompt:this.ensureGlobal(e.systemPrompt||this.promptPresets()["聊天助手"]),customPrompt:e.customPrompt||"",maxHistoryTurns:"number"===typeof e.maxHistoryTurns?e.maxHistoryTurns:this.defaultHistoryTurnsMap()[e.promptType||"聊天助手"],messages:(e.messages||[]).map(e=>({...e,timestamp:e.timestamp?new Date(e.timestamp):new Date}))}))}}catch(Ue){console.warn("加载聊天记录失败",Ue)}},saveLastChatId(e){try{localStorage.setItem(this.lastChatKey(),String(e))}catch(Ue){}},getLastChatId(){try{return localStorage.getItem(this.lastChatKey())}catch{return null}},createNewChat(){const e="聊天助手",t=this.promptPresets()[e],s={id:Date.now(),title:"新对话",messages:[],createdAt:new Date,updatedAt:new Date,promptType:e,systemPrompt:this.composeWithGlobal(t),customPrompt:"",promptAppliedAt:new Date,maxHistoryTurns:this.defaultHistoryTurnsMap()[e]};this.chatHistory.unshift(s),this.saveToStorage(),this.saveLastChatId(s.id),this.$emit("chat-selected",s),this.syncPromptUIFromChat(s.id)},selectChat(e){const t=this.chatHistory.find(t=>t.id===e);t&&(this.saveLastChatId(e),this.$emit("chat-selected",t),this.syncPromptUIFromChat(e))},deleteChat(e){const t=this.chatHistory.findIndex(t=>t.id===e);t>-1&&(this.chatHistory.splice(t,1),this.saveToStorage(),this.currentChatId===e&&(this.$emit("chat-deleted",e),this.chatHistory.length>0?this.selectChat(this.chatHistory[0].id):this.createNewChat()))},updateChatHistory(e){const t=this.chatHistory.findIndex(t=>t.id===e.id);if(t>-1){const s=e.messages.find(e=>"user"===e.type);let r=this.chatHistory[t].title;if(s){const e=s.text.substring(0,20)+(s.text.length>20?"...":"");("新对话"===r||""===r||r.startsWith("新对话"))&&(r=e)}const{promptType:a,systemPrompt:o,customPrompt:i,promptAppliedAt:n}=this.chatHistory[t];this.chatHistory[t]={...e,title:r,promptType:a,systemPrompt:this.ensureGlobal(o),customPrompt:i,promptAppliedAt:n},this.saveToStorage()}},applyPrompt(){if(!this.currentChatId)return;const e=this.chatHistory.find(e=>e.id===this.currentChatId);if(e){if(e.promptType=this.promptTypeSelection,"自定义"===this.promptTypeSelection)e.customPrompt=this.promptEditorContent.trim(),e.systemPrompt=this.composeWithGlobal(e.customPrompt);else{const t=this.promptPresets()[this.promptTypeSelection];e.systemPrompt=this.composeWithGlobal(t)}e.maxHistoryTurns=Number.isFinite(this.maxHistoryInput)?Math.max(0,Math.min(100,this.maxHistoryInput)):this.defaultHistoryTurnsMap()[e.promptType],e.promptAppliedAt=new Date,e.updatedAt=new Date,this.currentChatPromptAppliedAt=e.promptAppliedAt,this.saveToStorage(),this.$emit("chat-selected",{...e})}},onPromptTypeChange(){if("自定义"===this.promptTypeSelection){const e=this.chatHistory.find(e=>e.id===this.currentChatId);this.promptEditorContent=e?e.customPrompt||this.promptEditorContent||"":this.promptEditorContent||""}else this.promptEditorContent=this.promptPresets()[this.promptTypeSelection];this.maxHistoryInput=this.defaultHistoryTurnsMap()[this.promptTypeSelection]},syncPromptUIFromChat(e){const t=this.chatHistory.find(t=>t.id===e);if(t){if(this.promptTypeSelection=t.promptType||"聊天助手","自定义"===this.promptTypeSelection)this.promptEditorContent=t.customPrompt||"";else{const e=this.promptPresets()[this.promptTypeSelection];this.promptEditorContent=e}this.maxHistoryInput="number"===typeof t.maxHistoryTurns?t.maxHistoryTurns:this.defaultHistoryTurnsMap()[this.promptTypeSelection],this.currentChatPromptAppliedAt=t.promptAppliedAt||null}},formatTime(e){const t=e instanceof Date?e:new Date(e),s=new Date,r=s-t,a=Math.floor(r/6e4),o=Math.floor(r/36e5),i=Math.floor(r/864e5);return a<1?"刚刚":a<60?`${a}分钟前`:o<24?`${o}小时前`:i<7?`${i}天前`:t.toLocaleDateString()}},mounted(){if(this.loadFromStorage(),0===this.chatHistory.length)this.createNewChat();else{const e=this.getLastChatId(),t=this.chatHistory.find(t=>String(t.id)===String(e))||this.chatHistory[0];this.$emit("chat-selected",t),this.syncPromptUIFromChat(t.id)}window.addEventListener("beforeunload",this.saveToStorage)},beforeUnmount(){window.removeEventListener("beforeunload",this.saveToStorage)}};const _e=(0,Z.A)(Ee,[["render",$e],["__scopeId","data-v-e095943c"]]);var Oe=_e,je={name:"App",components:{ChatBox:te,SettingPanel:Oe},data(){return{selectedModel:"openai:gpt-4.1",currentChat:null,currentChatId:null}},methods:{handleModelChange(e){this.selectedModel=e},handleChatSelected(e){this.currentChat=e,this.currentChatId=e.id},handleChatDeleted(e){this.currentChatId===e&&(this.currentChat=null,this.currentChatId=null)},handleChatUpdated(e){this.currentChat=e,this.$refs.settingPanel&&this.$refs.settingPanel.updateChatHistory(e)},handleCreateNewChat(){this.$refs.settingPanel&&this.$refs.settingPanel.createNewChat&&this.$refs.settingPanel.createNewChat()}}};const Je=(0,Z.A)(je,[["render",i]]);var Re=Je;(0,r.Ef)(Re).mount("#app")}},t={};function s(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,s),o.exports}s.m=e,function(){var e=[];s.O=function(t,r,a,o){if(!r){var i=1/0;for(d=0;d<e.length;d++){r=e[d][0],a=e[d][1],o=e[d][2];for(var n=!0,l=0;l<r.length;l++)(!1&o||i>=o)&&Object.keys(s.O).every(function(e){return s.O[e](r[l])})?r.splice(l--,1):(n=!1,o<i&&(i=o));if(n){e.splice(d--,1);var p=a();void 0!==p&&(t=p)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[r,a,o]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};s.O.j=function(t){return 0===e[t]};var t=function(t,r){var a,o,i=r[0],n=r[1],l=r[2],p=0;if(i.some(function(t){return 0!==e[t]})){for(a in n)s.o(n,a)&&(s.m[a]=n[a]);if(l)var d=l(s)}for(t&&t(r);p<i.length;p++)o=i[p],s.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return s.O(d)},r=self["webpackChunkmy_vue_demo"]=self["webpackChunkmy_vue_demo"]||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))}();var r=s.O(void 0,[504],function(){return s(1213)});r=s.O(r)})();
//# sourceMappingURL=app.b62f2972.js.map